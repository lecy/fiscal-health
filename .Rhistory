## Packages
library( haven )        # importing data files
library( tidyr )        # data wrangling
library( dplyr )        # data wrangling
library( ggplot2 )      # fancy plots
library( ggthemes )     # fancy plots
library( scales )       # re-scaling numbers
library( stargazer )    # nice tables
library( pander )       # format tables for HTML
library( knitr )        # formatting functions
library( DT )           # embed datasets in HTML docs
library( urbnthemes )   # setting the color scheme to Urban's
set_urbn_defaults(style = "print")
source( "r-functions.R" )
variable.label <- "Debt to Equity Ratio"
# stargazer table print type
# run chunk for live RMD sessions
s.type <- "text"
# stargazer table print type
# resets to html when knitting
s.type <- "html"
## Load Data
# local:
# core <- readRDS( "02-data-wrangled/core.rds" )
# from github:
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
# Preview the data:
# table( core$NTMAJ12 ) %>% kable()
# head(core) %>% pander()
install.packages("urbnthemes" )
total_debt <- ( core$accntspayableend )
# can't divide by zero
unrs_net_assets <- (core$unrstrctnetasstsend )
unrs_net_assets[ unrs_net_assets == 0 ] <- NA
der <- (total_debt/unrs_net_assets)
summary( core$der )
nrow(core)
summary(core$accntspayableend)
summary( core$unrstrctnetasstsend )
summary( core$der )
core$der <- ( total_debt / unrs_net_assets )
summary( core$der )
x.05 <- quantile( core$der, 0.05, na.rm=T )
x.95 <- quantile( core$der, 0.95, na.rm=T )
x.05
x.95
remotes::install_github("UrbanInstitute/urbnthemes", build_vignettes = TRUE)
library( haven )        # importing data files
library( tidyr )        # data wrangling
library( dplyr )        # data wrangling
library( ggplot2 )      # fancy plots
library( ggthemes )     # fancy plots
library( scales )       # re-scaling numbers
library( stargazer )    # nice tables
library( pander )       # format tables for HTML
library( DT )           # embed datasets in HTML docs
source( "r-functions.R" )
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
bmf.2019 <- "https://www.dropbox.com/s/bi9ii23bo8l521h/nccs-bmf-2019.csv?dl=1"
bmf <- read.csv( bmf.2019 )
bmf <- select( bmf, EIN, NAME, ADDRESS, CITY, STATE, FIPS,
RULEDATE, NTEEFINAL, NTEECC,
NTEE1, NTMAJ5, NTMAJ10, NTMAJ12,
LEVEL1,	LEVEL2, LEVEL3, LEVEL4 )
bmf$RULEDATE <- substr( bmf$RULEDATE, 1, 4 ) %>% as.numeric()
bmf$RULEDATE[ bmf$RULEDATE < 1900 ] <- NA
bmf$AGE <- 2022 - bmf$RULEDATE
bmf <- read.csv( "01-data-raw/nccs-bmf-2019.csv" )
bmf <- select( bmf, EIN, NAME, ADDRESS, CITY, STATE, FIPS,
RULEDATE, NTEEFINAL, NTEECC,
NTEE1, NTMAJ5, NTMAJ10, NTMAJ12,
LEVEL1,	LEVEL2, LEVEL3, LEVEL4 )
bmf$RULEDATE <- substr( bmf$RULEDATE, 1, 4 ) %>% as.numeric()
bmf$RULEDATE[ bmf$RULEDATE < 1900 ] <- NA
library( haven )        # importing data files
library( tidyr )        # data wrangling
library( dplyr )        # data wrangling
library( ggplot2 )      # fancy plots
library( ggthemes )     # fancy plots
library( scales )       # re-scaling numbers
library( stargazer )    # nice tables
library( pander )       # format tables for HTML
library( DT )           # embed datasets in HTML docs
source( "r-functions.R" )
bmf <- select( bmf, EIN, NAME, ADDRESS, CITY, STATE, FIPS,
RULEDATE, NTEEFINAL, NTEECC,
NTEE1, NTMAJ5, NTMAJ10, NTMAJ12,
LEVEL1,	LEVEL2, LEVEL3, LEVEL4 )
bmf$RULEDATE <- substr( bmf$RULEDATE, 1, 4 ) %>% as.numeric()
bmf$RULEDATE[ bmf$RULEDATE < 1900 ] <- NA
bmf$AGE <- 2022 - bmf$RULEDATE
url.census <- "https://raw.githubusercontent.com/lecy/fiscal-health/main/01-data-raw/us-census-bureau-regions-and-divisions.csv"
census <- read.csv( url.census )
bmf <- merge( bmf, census, by.x="STATE", by.y="State.Code", all.x=TRUE )
core.2019.pc <- read.csv( "01-data-raw/irs-990-pc-soi-extract-2019.csv" )
nrow( core.2019.pc )
core.2019.pc <-
core.2019.pc %>%
select( ein,
tax_pd,
accntspayableend,
accntsrcvblend,
deprcatndepletn,
grntspayableend,
invntriesalesend,
lndbldgsequipend,
nonintcashend,
pldgegrntrcvblend,
prepaidexpnsend,
svngstempinvend,
totassetsend,
totfuncexpns,
totliabend,
totnetassetend,
totprgmrevnue,
totrevenue,
unrstrctnetasstsend )
core.2019.ez <- read.csv( "01-data-raw/irs-990-ez-soi-extract-2019.csv" )
core.2019.ez <- select( core.2019.ez, EIN, tax_pd,
totrevnue, totexpns, networthend,
totassetsend, totliabend, prgmservrev )
core.2019.ez <- rename( core.2019.ez,
ein = EIN,
totrevenue = totrevnue,
totprgmrevnue = prgmservrev,
totfuncexpns = totexpns,
totnetassetend = networthend,
totassetsend = totassetsend,
totliabend = totliabend  )
core <- bind_rows( core.2019.pc, core.2019.ez )
core$taxyr <- substr( core$tax_pd, 1, 4 )
core <- merge( core, bmf, by.x="ein", by.y="EIN", all.x=TRUE )
core$NTMAJ12v1 <- core$NTMAJ12
core$NTMAJ12[ core$NTMAJ12 == "AR" ] <- "Arts"
core$NTMAJ12[ core$NTMAJ12 == "BH" ] <- "Universities"
core$NTMAJ12[ core$NTMAJ12 == "ED" ] <- "Education"
core$NTMAJ12[ core$NTMAJ12 == "EH" ] <- "Hospitals"
core$NTMAJ12[ core$NTMAJ12 == "EN" ] <- "Environmental"
core$NTMAJ12[ core$NTMAJ12 == "HE" ] <- "Health"
core$NTMAJ12[ core$NTMAJ12 == "HU" ] <- "Human Services"
core$NTMAJ12[ core$NTMAJ12 == "IN" ] <- "International"
core$NTMAJ12[ core$NTMAJ12 == "MU" ] <- "Mutual Benefit"
core$NTMAJ12[ core$NTMAJ12 == "PU" ] <- "Public Benefit"
core$NTMAJ12[ core$NTMAJ12 == "RE" ] <- "Religion"
core$NTMAJ12[ core$NTMAJ12 == "UN" ] <- "Unknown"
core$NTMAJ12 <- factor( core$NTMAJ12 )
###
### STUDY SAMPLE
###
url.orgs <- "https://www.dropbox.com/s/fqk05x2ox3girq7/org-sample.csv?dl=1"
orgs <- read.csv( url.orgs )
orgs <- dplyr::select( orgs, orgname, ein )
# convert to integer to avoid leading zeros problem
orgs$ein <- as.numeric( orgs$ein )
# Check how many orgs from the study sample are in the core file?
intersect( orgs$ein, core$ein ) %>% length()
setdiff(   orgs$ein, core$ein ) %>% length()
core <- filter( core, ein %in% orgs$ein )
table( core$NTMAJ12 )
names(core)
# preview dataset
head(core) %>% pander()
saveRDS( core, "02-data-wrangled/core.rds" )
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
core <- readRDS( "02-data-wrangled/core.rds" )
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
URL <- "https://github.com/lecy/fiscal-health/raw/main/02-data-wrangled/core.rds"
core <- readRDS(gzcon(url( URL )))
